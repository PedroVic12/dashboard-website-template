<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atividades SP PLC ONS - Controle e Gestão </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    
    
    <!-- Nosso CSS (carregado via Flask) -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> -->


    <!-- Estilos Globais -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; }
        
        /* Scrollbar Personalizada */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Gráfico Donut CSS */
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; position: relative; }
        .pie-center { position: absolute; inset: 0; margin: auto; width: 70px; height: 70px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #334155; font-size: 0.9rem; flex-direction: column; }
        
        /* Sidebar */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Inputs de Tabela */
        .cell-input { width: 100%; background: transparent; border: 1px solid transparent; padding: 4px 6px; border-radius: 4px; font-size: 0.875rem; color: #334155; transition: all 0.2s; }
        .cell-input:focus { background: #fff; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .cell-input:hover { background: #f8fafc; border-color: #e2e8f0; }

        /* Colunas Redimensionáveis */
        .resizable-th { position: relative; }
        .resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 8px;
            cursor: col-resize; user-select: none; touch-action: none;
            background-color: transparent; z-index: 10;
        }
        .resizer:hover { background-color: rgba(59, 130, 246, 0.5); }
        
        /* Filtro Tabs */
        .filter-tab { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem;  }
        .filter-tab.active { background-color: #2563eb; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .filter-tab.inactive { color: #64748b; background-color: transparent; }
        .filter-tab.inactive:hover { background-color: #f1f5f9; color: #334155; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Bibliotecas JS (carregadas antes do nosso script) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Nosso Script (carregado via Flask) -->
    <!-- <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script> -->

    <!-- Script React inline (precisa do type="text/babel") -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 1. BIBLIOTECA DE ÍCONES ---
        const Icon = ({ path, className, onClick }) => (
                <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{cursor: onClick ? 'pointer' : 'inherit'}}>
                {path}
            </svg>
        );

        const Icons = {
            Menu: (p) => <Icon {...p} path={<><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>} />,
            Layout: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></>} />,
            Table: (p) => <Icon {...p} path={<><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></>} />,
            BarChart: (p) => <Icon {...p} path={<><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></>} />,
            Columns: (p) => <Icon {...p} path={<><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></>} />,
            Grid: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />,
            ThumbsUp: (p) => <Icon {...p} path={<><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<><polyline points="15 18 9 12 15 6"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><polyline points="9 18 15 12 9 6"/></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />
        };

        // --- 2. UTILITÁRIOS ---
        const Utils = {
            parseDate: (d) => {
                if (!d) return null;
                if (d instanceof Date) return new Date(d.setHours(0,0,0,0));
                if (typeof d === 'number') return new Date((d - (25567 + 2)) * 86400 * 1000);
                if (typeof d === 'string') {
                    const t = d.trim();
                    let m = t.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
                    if (m) return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
                    m = t.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
                    if (m) return new Date(parseInt(m[3]), parseInt(m[2])-1, parseInt(m[1]));
                }
                return null;
            },
            formatDate: (d) => d instanceof Date && !isNaN(d) ? d.toLocaleDateString("pt-BR") : "",
            getTodayString: () => new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
            daysInMonth: (month, year) => new Date(year, month + 1, 0).getDate(),
            calculateWorkdays: (dueDate) => {
                if (!dueDate || isNaN(dueDate.getTime())) return 0;
                let today = new Date(); today.setHours(0,0,0,0); dueDate.setHours(0,0,0,0);
                if (dueDate.getTime() === today.getTime()) return 0;
                let count = 0, current = new Date(today);
                const isFuture = dueDate > today;
                if (isFuture) {
                    current.setDate(current.getDate() + 1);
                    while (current <= dueDate) {
                        const day = current.getDay();
                        if (day !== 0 && day !== 6) count++;
                        current.setDate(current.getDate() + 1);
                    }
                    return count; 
                } else {
                    while (current > dueDate) {
                        current.setDate(current.getDate() - 1);
                        const day = current.getDay();
                        if (day !== 0 && day !== 6) count--;
                    }
                    return count; 
                }
            }
        };

        // --- 3. HELPER: REDIMENSIONAMENTO DE COLUNA ---
        const ResizableHeader = ({ children, width, minWidth = 50, onResize }) => {
            const handleMouseDown = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const startX = e.pageX;
                const startWidth = width;

                const handleMouseMove = (moveEvent) => {
                    const newWidth = Math.max(minWidth, startWidth + (moveEvent.pageX - startX));
                    onResize(newWidth); // Atualiza o estado pai diretamente
                };

                const handleMouseUp = () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            };

            return (
                <th className="p-3 border-b text-left relative resizable-th bg-slate-100 font-bold text-slate-700" style={{ width: width }}>
                    <div className="truncate pr-2">{children}</div>
                    <div className="resizer" onMouseDown={handleMouseDown} />
                </th>
            );
        };

        // --- 4. COMPONENTES DE PÁGINA (VIEWS) ---

        // >>> VIEW 1: DASHBOARD
        const DashboardView = ({ detailedActivities }) => {
            const total = detailedActivities.length;
            const done = detailedActivities.filter(t => (t.status||'').toLowerCase().includes('conclu')).length;
            const pending = total - done;
            const efficiency = total > 0 ? Math.round((done/total)*100) : 0;
            
            // Métricas de Ressalvas
            const comRessalva = detailedActivities.filter(t => t.obs && t.obs.trim().length > 0).length;
            const semRessalva = total - comRessalva;

            // Métricas de Responsáveis
            const uniqueResponsibles = [...new Set(detailedActivities.map(a => a.responsavel).filter(Boolean))];
            const responsiblesCount = uniqueResponsibles.length;

            // Dados por Responsável (Empilhado)
            const respStats = uniqueResponsibles.map(r => {
                const tasks = detailedActivities.filter(a => a.responsavel === r);
                const rDone = tasks.filter(t => (t.status||'').toLowerCase().includes('conclu')).length;
                const rPending = tasks.length - rDone;
                return { name: r, done: rDone, pending: rPending, total: tasks.length };
            }).sort((a,b) => b.total - a.total); // Ordenar por volume

            return (
                <div className="space-y-6 fade-in pb-10">
                    <h2 className="text-xl font-bold text-slate-800">Dashboard: Atividades SP MUST</h2>
                    
                    {/* Cards Superiores */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Total Atividades</p><p className="text-2xl font-bold text-slate-800 mt-1">{total}</p></div>
                            <div className="bg-blue-50 p-2 rounded-lg text-blue-600"><Icons.Layout/></div>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Responsáveis</p><p className="text-2xl font-bold text-indigo-600 mt-1">{responsiblesCount}</p></div>
                            <div className="bg-indigo-50 p-2 rounded-lg text-indigo-600"><Icons.Users/></div>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Com Ressalva</p><p className="text-2xl font-bold text-red-500 mt-1">{comRessalva}</p></div>
                            <div className="bg-red-50 p-2 rounded-lg text-red-500"><Icons.AlertCircle/></div>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Eficiência</p><p className="text-2xl font-bold text-emerald-600 mt-1">{efficiency}%</p></div>
                            <div className="bg-emerald-50 p-2 rounded-lg text-emerald-600"><Icons.BarChart/></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {/* Gráfico de Status */}
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center">
                            <h3 className="text-sm font-bold text-slate-600 uppercase mb-6 w-full border-b pb-2">Status Geral</h3>
                            <div className="pie-chart" style={{background: `conic-gradient(#10b981 0% ${(done/total)*100}%, #f59e0b ${(done/total)*100}% 100%)`}}>
                                <div className="pie-center"><span>{efficiency}%</span><span className="text-[10px] font-normal text-slate-400">Concluído</span></div>
                            </div>
                            <div className="flex gap-4 mt-8 text-xs font-medium">
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded-full bg-emerald-500"></div> Concluído ({done})</div>
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded-full bg-amber-500"></div> Pendente ({pending})</div>
                            </div>
                        </div>

                        {/* Gráfico de Ressalvas */}
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center">
                            <h3 className="text-sm font-bold text-slate-600 uppercase mb-6 w-full border-b pb-2">Atividades c/ Ressalva</h3>
                            <div className="pie-chart" style={{background: `conic-gradient(#ef4444 0% ${(comRessalva/total)*100}%, #e2e8f0 ${(comRessalva/total)*100}% 100%)`}}>
                                <div className="pie-center"><span className="text-red-500">{comRessalva}</span><span className="text-[10px] font-normal text-slate-400">Alertas</span></div>
                            </div>
                            <div className="flex gap-4 mt-8 text-xs font-medium">
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded-full bg-red-500"></div> C/ Ressalva</div>
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded-full bg-slate-200"></div> S/ Ressalva</div>
                            </div>
                        </div>

                        {/* Gráfico de Responsáveis (Barras Empilhadas) */}
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm col-span-1 lg:col-span-1 overflow-hidden flex flex-col">
                            <h3 className="text-sm font-bold text-slate-600 uppercase mb-4 w-full border-b pb-2">Atividades por Responsável</h3>
                            <div className="flex-grow overflow-y-auto custom-scrollbar pr-2" style={{maxHeight: '300px'}}>
                                {respStats.map((r, i) => (
                                    <div key={i} className="mb-3">
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="font-semibold text-slate-700 truncate w-24" title={r.name}>{r.name}</span>
                                            <span className="text-slate-500">{r.total} atv.</span>
                                        </div>
                                        <div className="w-full h-4 bg-slate-100 rounded-full flex overflow-hidden">
                                            {r.done > 0 && (
                                                <div className="bg-emerald-500 h-full flex items-center justify-center text-[8px] text-white" 
                                                     style={{width: `${(r.done/r.total)*100}%`}} title={`Concluído: ${r.done}`}>
                                                    {r.done}
                                                </div>
                                            )}
                                            {r.pending > 0 && (
                                                <div className="bg-amber-400 h-full flex items-center justify-center text-[8px] text-white" 
                                                     style={{width: `${(r.pending/r.total)*100}%`}} title={`Pendente: ${r.pending}`}>
                                                    {r.pending}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-4 mt-2 text-xs font-medium border-t pt-2">
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-emerald-500"></div> Concluído</div>
                                <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-amber-400"></div> Pendente</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // >>> VIEW 2: TAREFAS PLC ONS
        const PLCTableView = ({ tasks, onUpdate, onDelete, onAdd, onImport }) => {
            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(tasks.map(t => ({'Tarefa': t.title, 'Responsável': t.assignee, 'Status': t.status, 'Inicio': t.date, 'Fim': t.endDate})));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tarefas PLC");
                XLSX.writeFile(wb, "Tarefas_PLC_ONS.xlsx");
            };
            const fileRef = useRef(null);
            return (
                <div className="flex flex-col h-full fade-in">
                    <div className="flex justify-between items-center mb-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div>
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.Layout className="text-blue-600"/> Tarefas PLC ONS</h2>
                            <p className="text-xs text-slate-500">Tabela editável com controle de prazos</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>fileRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded hover:bg-emerald-100 text-xs font-medium transition"><Icons.Upload className="w-3 h-3"/> Importar</button>
                            <input type="file" ref={fileRef} hidden accept=".xlsx, .xls" onChange={onImport} />
                            <button onClick={exportExcel} className="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 border border-blue-200 rounded hover:bg-blue-100 text-xs font-medium transition"><Icons.Download className="w-3 h-3"/> Exportar</button>
                        </div>
                    </div>
                    <div className="bg-white border rounded-xl shadow-sm flex-grow overflow-hidden flex flex-col">
                        <div className="overflow-auto custom-scrollbar flex-grow">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-600 font-semibold sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="p-3 w-12 text-center border-b">#</th>
                                        <th className="p-3 border-b min-w-[200px]">Atividade / Tarefa</th>
                                        <th className="p-3 w-40 border-b">Responsável</th>
                                        <th className="p-3 w-32 border-b">Status</th>
                                        <th className="p-3 w-32 border-b">Início</th>
                                        <th className="p-3 w-32 border-b">Fim</th>
                                        <th className="p-3 w-16 text-center border-b">Ação</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {tasks.map((task, idx) => (
                                        <tr key={task.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-2 text-center text-slate-400 text-xs">{idx + 1}</td>
                                            <td className="p-2"><input className="cell-input font-medium" value={task.title} onChange={e => onUpdate(task.id, 'title', e.target.value)} placeholder="Nova tarefa..." /></td>
                                            <td className="p-2"><input className="cell-input" value={task.assignee} onChange={e => onUpdate(task.id, 'assignee', e.target.value)} placeholder="Responsável" /></td>
                                            <td className="p-2">
                                                <select className={`cell-input h-8 px-2 rounded cursor-pointer ${task.status === 'done' ? 'bg-emerald-50 text-emerald-700 font-medium' : task.status === 'in-progress' ? 'bg-blue-50 text-blue-700 font-medium' : 'bg-slate-100 text-slate-600'}`} value={task.status} onChange={e => onUpdate(task.id, 'status', e.target.value)}>
                                                    <option value="todo">Pendente</option>
                                                    <option value="in-progress">Andamento</option>
                                                    <option value="done">Concluído</option>
                                                </select>
                                            </td>
                                            <td className="p-2"><input type="date" className="cell-input text-xs text-slate-500" value={task.date} onChange={e => onUpdate(task.id, 'date', e.target.value)} /></td>
                                            <td className="p-2"><input type="date" className="cell-input text-xs text-slate-500" value={task.endDate} onChange={e => onUpdate(task.id, 'endDate', e.target.value)} /></td>
                                            <td className="p-2 text-center"><button onClick={() => onDelete(task.id)} className="p-1 text-slate-300 hover:text-red-500 transition"><Icons.Trash2 width="16"/></button></td>
                                        </tr>
                                    ))}
                                    {tasks.length === 0 && <tr><td colSpan="7" className="p-8 text-center text-slate-400">Nenhuma tarefa. Adicione uma nova ou importe do Excel.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={onAdd} className="w-full py-3 text-center text-sm text-blue-600 hover:bg-blue-50 font-medium border-t flex items-center justify-center gap-2 transition-colors"><Icons.Plus width="16"/> Adicionar Nova Linha</button>
                    </div>
                </div>
            );
        };

        // >>> VIEW 3: ATIVIDADES SP MUST (Com Filtros e Colunas Redimensionáveis)
        const DetailedReportView = ({ activities, onImport }) => {
            const [filterOrigin, setFilterOrigin] = useState('Consolidado');
            const [filterResponsible, setFilterResponsible] = useState('Todos');
            const [searchTerm, setSearchTerm] = useState('');
            const fileRef = useRef(null);

            // Larguras iniciais das colunas
            const [colWidths, setColWidths] = useState({
                origem: 120,
                atividade: 300,
                responsavel: 150,
                data: 100,
                dias: 80,
                obs: 200
            });

            // Extrair opções únicas para os filtros
            const uniqueOrigins = useMemo(() => ['Consolidado', ...new Set(activities.map(a => a.sheetName).filter(Boolean))], [activities]);
            const uniqueResponsibles = useMemo(() => ['Todos', ...new Set(activities.map(a => a.responsavel).filter(Boolean))], [activities]);

            // Lógica de Filtragem
            const filteredActivities = useMemo(() => {
                return activities.filter(item => {
                    const matchesOrigin = filterOrigin === 'Consolidado' || item.sheetName === filterOrigin;
                    const matchesResp = filterResponsible === 'Todos' || item.responsavel === filterResponsible;
                    const matchesSearch = searchTerm === '' || 
                                          item.atividade.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                          (item.obs && item.obs.toLowerCase().includes(searchTerm.toLowerCase()));
                    return matchesOrigin && matchesResp && matchesSearch;
                });
            }, [activities, filterOrigin, filterResponsible, searchTerm]);

            const exportDetailed = () => {
                const dataToExport = filteredActivities.map(a => ({
                    ID: a.id, Origem: a.sheetName, Atividade: a.atividade, 
                    Responsável: a.responsavel, Status: a.status, 
                    Previsão: Utils.formatDate(a.dueDate), 
                    'Dias Úteis': Utils.calculateWorkdays(a.dueDate),
                    Obs: a.obs
                }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Atividades_Filtradas");
                XLSX.writeFile(wb, `Atividades_SP_MUST.xlsx`);
            };

            return (
                <div className="flex flex-col h-full fade-in">
                    
                    {/* CONTAINER DE FILTROS SUPERIOR */}
                    <div className="flex flex-col gap-4 mb-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex justify-between items-center">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.Table className="text-purple-600"/> Atividades SP MUST</h2>
                                <p className="text-xs text-slate-500">Gestão e Filtros do Relatório Importado</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>fileRef.current.click()} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded hover:bg-emerald-100 text-xs font-medium transition"><Icons.Upload className="w-3 h-3"/> Importar Excel</button>
                                <input type="file" ref={fileRef} hidden accept=".xlsx, .xls" onChange={onImport} />
                                <button onClick={exportDetailed} className="flex items-center gap-2 px-3 py-1.5 bg-purple-50 text-purple-700 border border-purple-200 rounded hover:bg-purple-100 text-xs font-medium transition"><Icons.Download className="w-3 h-3"/> Exportar</button>
                            </div>
                        </div>
                        
                        {/* Linha de Controles de Filtro */}
                        <div className="flex flex-wrap items-center gap-3 pt-2 border-t border-slate-100 mt-2">
                            
                            {/* Filtro Origem */}
                            <div className="flex flex-col">
                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Visualização (Aba)</label>
                                <select 
                                    className="text-sm border border-slate-300 rounded px-2 py-1.5 bg-white focus:border-blue-500 outline-none min-w-[150px]"
                                    value={filterOrigin}
                                    onChange={(e) => setFilterOrigin(e.target.value)}
                                >
                                    {uniqueOrigins.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>

                            {/* Filtro Responsável */}
                            <div className="flex flex-col">
                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Responsável</label>
                                <select 
                                    className="text-sm border border-slate-300 rounded px-2 py-1.5 bg-white focus:border-blue-500 outline-none min-w-[150px]"
                                    value={filterResponsible}
                                    onChange={(e) => setFilterResponsible(e.target.value)}
                                >
                                    {uniqueResponsibles.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>

                            {/* Busca Texto */}
                            <div className="flex flex-col flex-grow">
                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Busca Rápida</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        placeholder="Buscar atividade ou observação..." 
                                        className="w-full text-sm border border-slate-300 rounded pl-8 pr-2 py-1.5 focus:border-blue-500 outline-none"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <div className="absolute left-2.5 top-2 text-slate-400"><Icons.Search className="w-3.5 h-3.5" /></div>
                                </div>
                            </div>

                            <div className="flex flex-col justify-end">
                                <span className="text-xs font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded self-end mb-0.5 mt-auto">
                                    {filteredActivities.length} itens
                                </span>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white border rounded-xl shadow-sm flex-grow overflow-hidden flex flex-col">
                        <div className="overflow-auto h-full custom-scrollbar">
                            <table className="text-sm text-left border-collapse table-fixed" style={{minWidth: '100%'}}>
                                <thead className="bg-slate-100 text-slate-700 font-bold sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <ResizableHeader width={colWidths.origem} onResize={(w) => setColWidths({...colWidths, origem: w})}>Origem</ResizableHeader>
                                        <ResizableHeader width={colWidths.atividade} onResize={(w) => setColWidths({...colWidths, atividade: w})}>Atividade</ResizableHeader>
                                        <ResizableHeader width={colWidths.responsavel} onResize={(w) => setColWidths({...colWidths, responsavel: w})}>Responsável</ResizableHeader>
                                        <ResizableHeader width={colWidths.data} onResize={(w) => setColWidths({...colWidths, data: w})}>Data Limite</ResizableHeader>
                                        <ResizableHeader width={colWidths.dias} onResize={(w) => setColWidths({...colWidths, dias: w})}>Dias Úteis</ResizableHeader>
                                        <ResizableHeader width={colWidths.obs} onResize={(w) => setColWidths({...colWidths, obs: w})}>Obs</ResizableHeader>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredActivities.map((row, i) => {
                                        const wd = Utils.calculateWorkdays(row.dueDate);
                                        const wdColor = wd < 0 ? 'text-red-600 font-bold bg-red-50' : wd < 5 ? 'text-amber-600 font-medium' : 'text-emerald-600';
                                        
                                        return (
                                            <tr key={i} className="hover:bg-slate-50 transition-colors group">
                                                <td className="p-3 text-[10px] text-slate-500 uppercase tracking-wide font-bold truncate border-r border-transparent group-hover:border-slate-100">{row.sheetName}</td>
                                                <td className="p-3 font-medium text-slate-700 truncate" title={row.atividade}>{row.atividade}</td>
                                                <td className="p-3 text-slate-600 truncate"><span className="bg-slate-100 px-2 py-0.5 rounded text-xs border">{row.responsavel}</span></td>
                                                <td className="p-3 text-center text-slate-500 text-xs truncate">{Utils.formatDate(row.dueDate)}</td>
                                                <td className="p-3 text-center"><span className={`px-2 py-0.5 rounded ${wdColor}`}>{wd}</span></td>
                                                <td className="p-3 text-xs text-slate-500 italic truncate" title={row.obs}>{row.obs}</td>
                                            </tr>
                                        );
                                    })}
                                    {filteredActivities.length === 0 && (
                                        <tr><td colSpan="6" className="p-10 text-center text-slate-400">Nenhum dado encontrado com os filtros atuais.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // >>> VIEW 4: PLANNER (Semana/Mês)
        const PlannerView = ({ plannerData, setPlannerData, allTasks }) => {
            const [mode, setMode] = useState('week'); 
            const [dragItem, setDragItem] = useState(null);

            const onDragStart = (e, item, list) => setDragItem({item, list});
            const onDrop = (e, targetList) => {
                if(!dragItem) return;
                const { item, list } = dragItem;
                if(list !== targetList) {
                    setPlannerData(prev => {
                        const newState = {...prev};
                        newState[list] = newState[list].filter(i => i.id !== item.id);
                        newState[targetList] = [...newState[targetList], item];
                        return newState;
                    });
                }
                setDragItem(null);
            };
            const addItem = (list, text) => { if(text.trim()) setPlannerData(prev => ({...prev, [list]: [...prev[list], {id: Date.now(), text}]})); };
            const removeItem = (list, id) => { setPlannerData(prev => ({...prev, [list]: prev[list].filter(i => i.id !== id)})); };

            const WeekColumn = ({ title, listKey, items }) => {
                const [input, setInput] = useState('');
                return (
                    <div className="min-w-[240px] flex flex-col bg-slate-50 rounded-lg border h-full" onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, listKey)}>
                        <div className="p-3 border-b bg-white rounded-t-lg flex justify-between items-center font-bold text-slate-700 text-sm">
                            {title}<span className="bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full text-xs">{items.length}</span>
                        </div>
                        <div className="flex-grow p-2 space-y-2 overflow-y-auto custom-scrollbar">
                            {items.map(item => (
                                <div key={item.id} draggable onDragStart={e => onDragStart(e, item, listKey)} className="bg-white p-3 rounded border shadow-sm text-sm cursor-grab hover:border-blue-300 group relative transition-all">
                                    {item.text}<button onClick={()=>removeItem(listKey, item.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2 width="14"/></button>
                                </div>
                            ))}
                        </div>
                        <div className="p-2 border-t bg-white rounded-b-lg">
                            <input className="w-full text-xs p-2 border rounded focus:ring-2 focus:ring-blue-100 outline-none" placeholder="+ Adicionar" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'){addItem(listKey, input); setInput('');}}} />
                        </div>
                    </div>
                );
            };

            const MonthCalendar = () => {
                const today = new Date();
                const [currentMonth, setCurrentMonth] = useState(today.getMonth());
                const [currentYear, setCurrentYear] = useState(today.getFullYear());
                const daysInMonth = Utils.daysInMonth(currentMonth, currentYear);
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const blanks = Array(firstDay).fill(null);
                const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
                const monthName = new Date(currentYear, currentMonth).toLocaleString('pt-BR', { month: 'long' });

                const getTasksForDay = (day) => {
                    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    return allTasks.filter(t => t.date === dateStr || (t.dueDate && Utils.formatDate(t.dueDate) === Utils.formatDate(new Date(currentYear, currentMonth, day))));
                };

                return (
                    <div className="bg-white rounded-xl border p-4 h-full flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={()=>setCurrentMonth(p=>p===0?11:p-1)} className="p-1 hover:bg-slate-100 rounded"><Icons.ChevronLeft/></button>
                            <h3 className="font-bold capitalize text-lg text-slate-800">{monthName} {currentYear}</h3>
                            <button onClick={()=>setCurrentMonth(p=>p===11?0:p+1)} className="p-1 hover:bg-slate-100 rounded"><Icons.ChevronRight/></button>
                        </div>
                        <div className="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-slate-400 text-xs uppercase"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div></div>
                        <div className="grid grid-cols-7 gap-2 flex-grow overflow-y-auto custom-scrollbar">
                            {blanks.map((_, i) => <div key={`b-${i}`} className="bg-slate-50/50 rounded min-h-[80px]"></div>)}
                            {days.map(d => {
                                const dayTasks = getTasksForDay(d);
                                const isToday = d === today.getDate() && currentMonth === today.getMonth();
                                return (
                                    <div key={d} className={`border rounded p-1 flex flex-col min-h-[100px] overflow-hidden ${isToday ? 'border-blue-400 bg-blue-50/30' : 'border-slate-100'}`}>
                                        <span className={`text-xs font-bold mb-1 ${isToday ? 'text-blue-600' : 'text-slate-400'}`}>{d}</span>
                                        <div className="flex-grow space-y-1 overflow-y-auto custom-scrollbar">
                                            {dayTasks.map((t, i) => (
                                                <div key={i} className="text-[10px] bg-indigo-50 text-indigo-700 px-1 py-0.5 rounded truncate border border-indigo-100" title={t.title || t.atividade}>{t.title || t.atividade}</div>
                                            ))}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col fade-in">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm mb-4">
                        <div><h2 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Icons.Columns className="text-indigo-600"/> Planner</h2><p className="text-xs text-slate-500 capitalize">{Utils.getTodayString()}</p></div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={()=>setMode('week')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${mode==='week'?'bg-white shadow text-slate-800':'text-slate-500'}`}>Semana</button>
                            <button onClick={()=>setMode('month')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition ${mode==='month'?'bg-white shadow text-slate-800':'text-slate-500'}`}>Mês</button>
                        </div>
                    </div>
                    {mode === 'week' ? (
                        <div className="flex-grow overflow-x-auto pb-2 flex gap-4">
                            <WeekColumn title="Backlog" listKey="backlog" items={plannerData.backlog} />
                            <WeekColumn title="Segunda" listKey="mon" items={plannerData.mon} />
                            <WeekColumn title="Terça" listKey="tue" items={plannerData.tue} />
                            <WeekColumn title="Quarta" listKey="wed" items={plannerData.wed} />
                            <WeekColumn title="Quinta" listKey="thu" items={plannerData.thu} />
                            <WeekColumn title="Sexta" listKey="fri" items={plannerData.fri} />
                        </div>
                    ) : ( <MonthCalendar /> )}
                </div>
            );
        };

        // >>> VIEW 5: EISENHOWER
        const EisenhowerView = ({ eisenData, setEisenData }) => {
            const [dragItem, setDragItem] = useState(null);
            const onDragStart = (e, item, list) => setDragItem({item, list});
            const onDrop = (e, targetList) => {
                if(!dragItem) return;
                const { item, list } = dragItem;
                if(list !== targetList) {
                    setEisenData(prev => {
                        const newState = {...prev};
                        newState[list] = newState[list].filter(i => i.id !== item.id);
                        newState[targetList] = [...newState[targetList], item];
                        return newState;
                    });
                }
                setDragItem(null);
            };
            const addItem = (list, text) => { if(text.trim()) setEisenData(prev => ({...prev, [list]: [...prev[list], {id: Date.now(), text}]})); };
            const removeItem = (list, id) => { setEisenData(prev => ({...prev, [list]: prev[list].filter(i => i.id !== id)})); };

            const Quadrant = ({ title, listKey, bg, color }) => {
                const [input, setInput] = useState('');
                return (
                    <div className={`p-4 rounded-xl border flex flex-col ${bg} ${color}`} onDragOver={e=>e.preventDefault()} onDrop={e=>onDrop(e, listKey)}>
                        <h3 className="font-bold mb-3 uppercase text-xs tracking-wider opacity-80">{title}</h3>
                        <div className="flex-grow space-y-2 overflow-y-auto custom-scrollbar">
                            {eisenData[listKey].map(item => (
                                <div key={item.id} draggable onDragStart={e=>onDragStart(e, item, listKey)} className="bg-white p-3 rounded shadow-sm text-sm text-slate-800 cursor-grab flex justify-between group hover:shadow-md transition">
                                    <span>{item.text}</span><button onClick={()=>removeItem(listKey, item.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icons.Trash2 width="14"/></button>
                                </div>
                            ))}
                        </div>
                        <input className="mt-3 w-full text-xs p-2 rounded border-0 shadow-sm focus:ring-2 focus:ring-opacity-50 focus:ring-blue-500" placeholder="Adicionar..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'){addItem(listKey, input); setInput('');}}} />
                    </div>
                );
            };

            return (
                <div className="h-full grid grid-cols-2 grid-rows-2 gap-4 fade-in">
                    <Quadrant title="Urgente & Importante" listKey="urgentImportant" bg="bg-red-50 border-red-200" color="text-red-800" />
                    <Quadrant title="Não Urgente & Importante" listKey="notUrgentImportant" bg="bg-blue-50 border-blue-200" color="text-blue-800" />
                    <Quadrant title="Urgente & Não Importante" listKey="urgentNotImportant" bg="bg-amber-50 border-amber-200" color="text-amber-800" />
                    <Quadrant title="Não Urgente & Não Importante" listKey="notUrgentNotImportant" bg="bg-slate-100 border-slate-200" color="text-slate-700" />
                </div>
            );
        };

        // >>> VIEW 6: PRÓS & CONTRAS
        const ProsConsView = ({ pcData, setPcData }) => {
            const addItem = (type, text) => { if(text.trim()) setPcData(prev => ({...prev, [type]: [...prev[type], {id: Date.now(), text}]})); };
            const removeItem = (type, id) => { setPcData(prev => ({...prev, [type]: prev[type].filter(i => i.id !== id)})); };

            const List = ({ type, items, color, bg }) => {
                const [input, setInput] = useState('');
                return (
                    <div className={`flex-1 p-6 rounded-xl border flex flex-col ${bg} ${color}`}>
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2">{type==='pros'?<Icons.ThumbsUp/>:<Icons.ThumbsUp className="rotate-180"/>} {type==='pros'?'Prós':'Contras'}</h3>
                        <ul className="flex-grow space-y-3 overflow-y-auto custom-scrollbar">
                            {items.map(item => (
                                <li key={item.id} className="flex items-center group bg-white/60 p-3 rounded-lg shadow-sm">
                                    <div className={`w-2 h-2 rounded-full mr-3 ${type==='pros'?'bg-emerald-400':'bg-rose-400'}`}></div>
                                    <span className="flex-grow text-slate-700 font-medium">{item.text}</span>
                                    <button onClick={()=>removeItem(type, item.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icons.Trash2 width="14"/></button>
                                </li>
                            ))}
                        </ul>
                        <div className="mt-4 bg-white rounded-lg p-1 shadow-sm border border-slate-200 flex">
                            <input className="flex-grow p-2 text-sm outline-none bg-transparent" placeholder="Adicionar argumento..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'){addItem(type, input); setInput('');}}} />
                            <button onClick={()=>{addItem(type, input); setInput('');}} className="px-3 py-1 rounded bg-slate-100 hover:bg-slate-200 text-slate-600"><Icons.Plus width="16"/></button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col md:flex-row gap-6 fade-in">
                    <List type="pros" items={pcData.pros} bg="bg-emerald-50 border-emerald-100" color="text-emerald-800" />
                    <List type="cons" items={pcData.cons} bg="bg-rose-50 border-rose-100" color="text-rose-800" />
                </div>
            );
        };

        // --- 4. COMPONENTES APP PRINCIPAL ---
        function App() {
            const [currentView, setCurrentView] = useState('dashboard');
            const [isSidebarOpen, setSidebarOpen] = useState(true);

            // --- ESTADO UNIFICADO ---
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('project_hub_v1');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed.detailedActivities) parsed.detailedActivities.forEach(a => a.dueDate = Utils.parseDate(a.dueDate));
                        if(parsed.simpleTasks) parsed.simpleTasks.forEach(a => a.dueDate = Utils.parseDate(a.dueDate)); 
                        return parsed;
                    } catch(e) { console.error("Erro ao carregar dados", e); }
                }
                return {
                    simpleTasks: [
                        {id: 1, title: 'Kickoff', assignee: 'Ana', status: 'done', date: '2026-01-20', endDate: '2026-01-22'},
                        {id: 2, title: 'Desenvolvimento', assignee: 'Carlos', status: 'in-progress', date: '2026-01-23', endDate: '2026-02-10'}
                    ],
                    detailedActivities: [],
                    planner: {backlog: [], mon: [], tue: [], wed: [], thu: [], fri: []},
                    eisenhower: {urgentImportant: [], notUrgentImportant: [], urgentNotImportant: [], notUrgentNotImportant: []},
                    prosCons: {pros: [], cons: []}
                };
            });

            // Persistência
            useEffect(() => {
                localStorage.setItem('project_hub_v1', JSON.stringify(data));
            }, [data]);

            // Handlers Globais
            const handleUpdatePLC = (id, field, val) => setData(prev => ({...prev, simpleTasks: prev.simpleTasks.map(t => t.id === id ? {...t, [field]: val} : t)}));
            const handleAddPLC = () => setData(prev => ({...prev, simpleTasks: [...prev.simpleTasks, {id: Date.now(), title: '', assignee: '', status: 'todo', date: '', endDate: ''}]}));
            const handleDeletePLC = (id) => setData(prev => ({...prev, simpleTasks: prev.simpleTasks.filter(t => t.id !== id)}));
            const handleImportPLC = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const mapped = json.map((r, i) => ({
                        id: Date.now()+i, title: r['Tarefa']||r['Atividade']||'', assignee: r['Responsável']||'', status: r['Status']==='Concluído'?'done':'todo', date: r['Inicio']||'', endDate: r['Fim']||''
                    }));
                    setData(prev => ({...prev, simpleTasks: mapped}));
                    alert("Tarefas PLC Importadas!");
                };
                reader.readAsBinaryString(file);
            };

            const handleImportDetailed = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, {type: 'binary'});
                    let allRows = [];
                    
                    // Iterate over ALL sheets in the workbook
                    wb.SheetNames.forEach(sheetName => {
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                        const mapped = json.map((r, i) => {
                            // Helper to find date field based on user CSV headers
                            const dateVal = r['DATA LIMITE'] || r['PREVISÃO DE TÉRMINO'] || r['Previsão'] || r['Data'];
                            return {
                                id: `${sheetName}-${i}`,
                                sheetName: sheetName, // Store Origin Sheet
                                atividade: r['ATIVIDADES'] || r['Atividade'] || 'Sem Título',
                                responsavel: r['RESPONSÁVEL'] || r['Responsável'] || '',
                                status: sheetName.toUpperCase().includes('CONCLUÍDO') ? 'Concluído' : 'Pendente',
                                dueDate: Utils.parseDate(dateVal),
                                obs: r['OBSERVAÇÃO'] || r['Obs'] || ''
                            };
                        });
                        allRows = [...allRows, ...mapped];
                    });
                    
                    setData(prev => ({...prev, detailedActivities: allRows}));
                    alert(`${allRows.length} atividades importadas de todas as abas!`);
                };
                reader.readAsBinaryString(file);
            };

            const setPlannerData = (fn) => setData(prev => ({...prev, planner: typeof fn === 'function' ? fn(prev.planner) : fn}));
            const setEisenData = (fn) => setData(prev => ({...prev, eisenhower: typeof fn === 'function' ? fn(prev.eisenhower) : fn}));
            const setPcData = (fn) => setData(prev => ({...prev, prosCons: typeof fn === 'function' ? fn(prev.prosCons) : fn}));


            return (
                <div className="flex h-screen bg-slate-50">
                    <aside className={`bg-slate-900 text-white flex flex-col shadow-xl z-20 sidebar-transition overflow-hidden ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                        <div className="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-900 shrink-0">
                            <div className="bg-blue-600 p-1.5 rounded mr-3"><Icons.Layout className="text-white"/></div>
                            {isSidebarOpen && <span className="font-bold text-lg tracking-tight whitespace-nowrap">ProjectHub</span>}
                        </div>
                        <nav className="flex-grow py-6 space-y-1 px-3 overflow-y-auto custom-scrollbar">
                            {[
                                {id: 'dashboard', icon: <Icons.BarChart/>, label: 'Dashboard'},
                                {id: 'plc', icon: <Icons.Layout/>, label: 'Tarefas PLC'},
                                {id: 'detailed', icon: <Icons.Table/>, label: 'Atividades SP MUST'},
                                {id: 'planner', icon: <Icons.Columns/>, label: 'Planner'},
                                {id: 'eisenhower', icon: <Icons.Grid/>, label: 'Matriz Eis.'},
                                {id: 'proscons', icon: <Icons.ThumbsUp/>, label: 'Prós/Contras'},
                            ].map(item => (
                                <button key={item.id} onClick={() => setCurrentView(item.id)} className={`w-full flex items-center p-3 rounded-lg transition-all group relative ${currentView === item.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`} title={!isSidebarOpen ? item.label : ''}>
                                    <span className="shrink-0">{item.icon}</span>
                                    <span className={`ml-3 font-medium text-sm whitespace-nowrap transition-opacity duration-300 ${isSidebarOpen ? 'opacity-100' : 'opacity-0 absolute left-10 pointer-events-none'}`}>{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800 flex justify-center shrink-0 bg-slate-900">
                            <button onClick={()=>setSidebarOpen(!isSidebarOpen)} className="p-2 rounded-lg bg-slate-800 text-slate-400 hover:text-white transition shadow-sm border border-slate-700"><Icons.Menu /></button>
                        </div>
                    </aside>
                    <main className="flex-grow flex flex-col h-screen overflow-hidden relative">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm shrink-0 z-10">
                            <h1 className="text-xl font-bold text-slate-800">
                                {currentView === 'dashboard' && 'Visão Geral do Projeto'}
                                {currentView === 'plc' && 'Gerenciamento PLC ONS'}
                                {currentView === 'detailed' && 'Atividades SP MUST'}
                                {currentView === 'planner' && 'Planejamento Semanal'}
                                {currentView === 'eisenhower' && 'Matriz de Prioridades'}
                                {currentView === 'proscons' && 'Análise de Decisão'}
                            </h1>
                            <div className="text-xs text-slate-500 font-medium bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">{Utils.getTodayString()}</div>
                        </header>
                        <div className="flex-grow p-6 overflow-auto bg-slate-50/50 relative">
                            {currentView === 'dashboard' && <DashboardView simpleTasks={data.simpleTasks} detailedActivities={data.detailedActivities} />}
                            {currentView === 'plc' && <PLCTableView tasks={data.simpleTasks} onUpdate={handleUpdatePLC} onDelete={handleDeletePLC} onAdd={handleAddPLC} onImport={handleImportPLC} />}
                            {currentView === 'detailed' && <DetailedReportView activities={data.detailedActivities} onImport={handleImportDetailed} />}
                            {currentView === 'planner' && <PlannerView plannerData={data.planner} setPlannerData={setPlannerData} allTasks={[...data.simpleTasks, ...data.detailedActivities]} />}
                            {currentView === 'eisenhower' && <EisenhowerView eisenData={data.eisenhower} setEisenData={setEisenData} />}
                            {currentView === 'proscons' && <ProsConsView pcData={data.prosCons} setPcData={setPcData} />}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>