<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Dashboard de Análise - Pontos MUST (React)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React via CDN -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel (para transpilar JSX no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal-overlay { transition: opacity 0.3s ease; }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- DADOS MOCK (Expandidos para incluir novos campos) ---
        const mockData = [
            { "EMPRESA": "SUL E SUDESTE", "Cód ONS": "SPUFA-138", "Tensão (kV)": 138, "Ponta 2025 Valor": 3.0, "Ponta 2025 Anotacao": "D", "Fora Ponta 2025 Valor": 3.5, "Fora Ponta 2025 Anotacao": "D", "Ponta 2026 Valor": 3.0, "Ponta 2026 Anotacao": "D", "Fora Ponta 2026 Valor": 3.5, "Fora Ponta 2026 Anotacao": "D", "Ponta 2027 Valor": 3.0, "Ponta 2027 Anotacao": "D", "Fora Ponta 2027 Valor": 3.5, "Fora Ponta 2027 Anotacao": "D", "Ponta 2028 Valor": 3.0, "Ponta 2028 Anotacao": "D", "Fora Ponta 2028 Valor": 3.5, "Fora Ponta 2028 Anotacao": "D", "Anotacao": "O atendimento ao MUST fica condicionado à manutenibilidade da LT.", "ID_Problema": "PROB-001", "ID_Solucao": "SOL-001A" },
            { "EMPRESA": "SUL E SUDESTE", "Cód ONS": "SPASS188", "Tensão (kV)": 88, "Ponta 2025 Valor": 44.7, "Ponta 2025 Anotacao": "E", "Fora Ponta 2025 Valor": 41.9, "Fora Ponta 2025 Anotacao": "E", "Ponta 2026 Valor": 44.7, "Ponta 2026 Anotacao": "E", "Fora Ponta 2026 Valor": 41.9, "Fora Ponta 2026 Anotacao": "E", "Ponta 2027 Valor": 44.7, "Ponta 2027 Anotacao": "E", "Fora Ponta 2027 Valor": 41.9, "Fora Ponta 2027 Anotacao": "E", "Ponta 2028 Valor": 44.7, "Ponta 2028 Anotacao": "E", "Fora Ponta 2028 Valor": 41.9, "Fora Ponta 2028 Anotacao": "E", "Anotacao": "No ponto de ASSIS I 88 kV, a USUÁRIA declarou valores de MUST.", "ID_Problema": "PROB-002", "ID_Solucao": "SOL-002B" },
            { "EMPRESA": "PIRATININGA", "Cód ONS": "SPBAST138", "Tensão (kV)": 138, "Ponta 2025 Valor": 19.8, "Ponta 2025 Anotacao": "nan", "Fora Ponta 2025 Valor": 20.4, "Fora Ponta 2025 Anotacao": "nan", "Ponta 2026 Valor": 20.1, "Ponta 2026 Anotacao": "nan", "Fora Ponta 2026 Valor": 20.7, "Fora Ponta 2026 Anotacao": "nan", "Ponta 2027 Valor": 20.4, "Ponta 2027 Anotacao": "nan", "Fora Ponta 2027 Valor": 21.0, "Fora Ponta 2027 Anotacao": "nan", "Ponta 2028 Valor": 20.7, "Ponta 2028 Anotacao": "nan", "Fora Ponta 2028 Valor": 21.3, "Fora Ponta 2028 Anotacao": "nan", "Anotacao": "nan", "ID_Problema": "nan", "ID_Solucao": "nan" },
            { "EMPRESA": "ELETROPAULO", "Cód ONS": "SPBRB-138", "Tensão (kV)": 138, "Ponta 2025 Valor": 23.9, "Ponta 2025 Anotacao": "P", "Fora Ponta 2025 Valor": 24.4, "Fora Ponta 2025 Anotacao": "P", "Ponta 2026 Valor": 23.9, "Ponta 2026 Anotacao": "P", "Fora Ponta 2026 Valor": 24.4, "Fora Ponta 2026 Anotacao": "P", "Ponta 2027 Valor": 23.9, "Ponta 2027 Anotacao": "P", "Fora Ponta 2027 Valor": 24.4, "Fora Ponta 2027 Anotacao": "P", "Ponta 2028 Valor": 23.9, "Ponta 2028 Anotacao": "P", "Fora Ponta 2028 Valor": 24.4, "Fora Ponta 2028 Anotacao": "P", "Anotacao": "No ponto de BORBOREMA 138 kV, a USUÁRIA declarou valores.", "ID_Problema": "PROB-003", "ID_Solucao": "nan" }
        ];

        // --- COMPONENTES ---

        const CompanyCard = ({ company, stats }) => {
            const percentage = stats.total > 0 ? (stats.withRemarks / stats.total) * 100 : 0;
            return (
                <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-white truncate" title={company}>{company}</h3>
                    <div className="mt-4">
                        <div className="flex justify-between text-gray-400 text-sm">
                            <span>Solicitações com Ressalva</span>
                            <span className="font-bold text-white">{stats.withRemarks} / {stats.total}</span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                            <div className="bg-yellow-500 h-2.5 rounded-full" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AnnotationModal = ({ content, onClose }) => {
            if (!content) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 modal-overlay" style={{ opacity: 1 }} onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">Detalhes da Anotação</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div className="text-gray-300 whitespace-pre-wrap">{content}</div>
                    </div>
                </div>
            );
        };
        
        const PieChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Aprovado', 'Com Ressalva'],
                        datasets: [{
                            data: [data.approved, data.withRemarks],
                            backgroundColor: ['#22c55e', '#f59e0b'],
                            borderColor: '#1f2937',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#d1d5db'
                                }
                            }
                        }
                    }
                });
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);

            return <div className="h-64 md:h-80"><canvas ref={chartRef}></canvas></div>;
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [allData, setAllData] = useState([]);
            const [filters, setFilters] = useState({ year: '2025', period: 'Ponta', company: 'all', search: '' });
            const [modalContent, setModalContent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                // Simula o fetch para evitar erros de CORS no ambiente de preview
                try {
                    setAllData(mockData);
                    addToHistory('Dados iniciais carregados.');
                } catch (err) {
                    setError('Falha ao carregar dados mockados.');
                } finally {
                    setLoading(false);
                }
            }, []);

            const addToHistory = (action) => {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                setHistory(prev => [`[${timestamp}] ${action}`, ...prev].slice(0, 10));
            };

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => {
                    const newFilters = { ...prev, [name]: value };
                    addToHistory(`Filtro '${name}' alterado para '${value}'.`);
                    return newFilters;
                });
            };
            
            const hasRemarkInPeriod = (item, year, period) => {
                const annotationKey = `${period} ${year} Anotacao`;
                const generalAnnotation = item['Anotacao'];
                const specificAnnotation = item[annotationKey];
                return (specificAnnotation && String(specificAnnotation).trim().toLowerCase() !== 'nan') || 
                       (generalAnnotation && String(generalAnnotation).trim().toLowerCase() !== 'nan');
            };

            const globalStats = useMemo(() => {
                if (!allData || allData.length === 0) return { approved: 0, withRemarks: 0 };
                // Para o gráfico de pizza, consideramos o status no período de 2025 Ponta como referência
                const withRemarks = allData.filter(item => hasRemarkInPeriod(item, '2025', 'Ponta')).length;
                const approved = allData.length - withRemarks;
                return { approved, withRemarks };
            }, [allData]);

            const valueKey = useMemo(() => `${filters.period} ${filters.year} Valor`, [filters.period, filters.year]);
            const annotationKey = useMemo(() => `${filters.period} ${filters.year} Anotacao`, [filters.period, filters.year]);

            const filteredData = useMemo(() => {
                return allData.filter(item => {
                    const companyMatch = filters.company === 'all' || item.EMPRESA === filters.company;
                    const searchTerm = filters.search.toLowerCase();
                    const searchMatch = !searchTerm ||
                        Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm));
                    return companyMatch && searchMatch;
                });
            }, [allData, filters]);

            const companyAnalysis = useMemo(() => {
                const companyData = {};
                filteredData.forEach(item => {
                    if (!companyData[item.EMPRESA]) {
                        companyData[item.EMPRESA] = { total: 0, withRemarks: 0 };
                    }
                    companyData[item.EMPRESA].total++;
                    if (hasRemarkInPeriod(item, filters.year, filters.period)) {
                        companyData[item.EMPRESA].withRemarks++;
                    }
                });
                return Object.entries(companyData);
            }, [filteredData, filters.year, filters.period]);
            
            const availableCompanies = useMemo(() => [...new Set(allData.map(item => item.EMPRESA))].sort(), [allData]);

            const handleRemarkClick = (item) => {
                const specificAnnotation = item[annotationKey];
                const generalAnnotation = item['Anotacao'];
                let content = '';
                if (specificAnnotation && String(specificAnnotation).trim().toLowerCase() !== 'nan') {
                    content += `Anotação do Período (${filters.period} ${filters.year}):\n${specificAnnotation}\n\n`;
                }
                if (generalAnnotation && String(generalAnnotation).trim().toLowerCase() !== 'nan') {
                    content += `Anotação Geral do Ponto:\n${generalAnnotation}`;
                }
                if (content) {
                    setModalContent(content.trim());
                }
            };

            if (loading) return <div className="text-center p-8">Carregando dados...</div>;
            if (error) return <div className="container mx-auto p-4 md:p-8"><ErrorDisplay error={error} /></div>;

            return (
                <React.Fragment>
                    <div className="container mx-auto p-4 md:p-8">
                        <header className="mb-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-white">Dashboard de Análise de Pontos MUST</h1>
                            <p className="text-gray-400 mt-2">Visão geral das solicitações e ressalvas por empresa e ponto de conexão.</p>
                        </header>

                        <section className="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-2 bg-gray-800 p-6 rounded-lg">
                                <h2 className="text-2xl font-bold text-white mb-4">Estatísticas Gerais (Todos os Anos)</h2>
                                <p className="text-gray-400 mb-4">Gráfico de pizza representando o status dos pontos (baseado em 2025 Ponta).</p>
                                <PieChart data={globalStats} />
                            </div>
                            <div className="bg-gray-800 p-6 rounded-lg">
                                <h2 className="text-2xl font-bold text-white mb-4">Resumo</h2>
                                <div className="space-y-4">
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <p className="text-gray-400 text-sm">Total de Pontos (Todos os Anos)</p>
                                        <p className="text-2xl font-bold text-white">{allData.length}</p>
                                    </div>
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <p className="text-gray-400 text-sm">Total de Empresas</p>
                                        <p className="text-2xl font-bold text-white">{availableCompanies.length}</p>
                                    </div>
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <p className="text-gray-400 text-sm">Pontos Aprovados (2025 Ponta)</p>
                                        <p className="text-2xl font-bold text-green-400">{globalStats.approved}</p>
                                    </div>
                                     <div className="bg-gray-700 p-4 rounded-lg">
                                        <p className="text-gray-400 text-sm">Pontos com Ressalva (2025 Ponta)</p>
                                        <p className="text-2xl font-bold text-yellow-400">{globalStats.withRemarks}</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section className="mb-8">
                            <h2 className="text-2xl font-bold text-white mb-4">Análise por Empresa ({`${filters.period} ${filters.year}`})</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                {companyAnalysis.map(([company, stats]) => (
                                    <CompanyCard key={company} company={company} stats={stats} />
                                ))}
                            </div>
                        </section>

                        <section className="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 className="text-2xl font-bold text-white mb-4">Detalhes dos Pontos de Conexão</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label htmlFor="year-filter" className="block text-sm font-medium text-gray-400 mb-1">Ano</label>
                                    <select id="year-filter" name="year" value={filters.year} onChange={handleFilterChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                                        <option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="period-filter" className="block text-sm font-medium text-gray-400 mb-1">Período</label>
                                    <select id="period-filter" name="period" value={filters.period} onChange={handleFilterChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                                        <option value="Ponta">Ponta</option><option value="Fora Ponta">Fora Ponta</option>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="company-filter" className="block text-sm font-medium text-gray-400 mb-1">Empresa</label>
                                    <select id="company-filter" name="company" value={filters.company} onChange={handleFilterChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                                        <option value="all">Todas as Empresas</option>
                                        {availableCompanies.map(company => <option key={company} value={company}>{company}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="search-input" className="block text-sm font-medium text-gray-400 mb-1">Pesquisa</label>
                                    <input type="text" id="search-input" name="search" value={filters.search} onChange={handleFilterChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" placeholder="Buscar..." />
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-300">
                                    <thead className="text-xs text-gray-400 uppercase bg-gray-700">
                                        <tr>
                                            <th className="px-4 py-3">Ponto (Cód ONS)</th>
                                            <th className="px-4 py-3">Demanda Agente</th>
                                            <th className="px-4 py-3">ID Problema</th>
                                            <th className="px-4 py-3">ID Solução</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-700">
                                        {filteredData.filter(item => hasRemarkInPeriod(item, filters.year, filters.period)).map((item, index) => (
                                            <tr key={`${item['Cód ONS']}-${index}-analysis`} className="hover:bg-gray-700">
                                                <td className="px-4 py-2 font-medium text-white">{item['Cód ONS']}</td>
                                                <td className="px-4 py-2">{item[valueKey]}</td>
                                                <td className="px-4 py-2">{item['ID_Problema']}</td>
                                                <td className="px-4 py-2">{item['ID_Solucao']}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <section className="bg-gray-800 p-6 rounded-lg shadow-lg mt-8">
                            <h2 className="text-2xl font-bold text-white mb-4">Histórico de Análises da Sessão</h2>
                            <div className="bg-gray-900 rounded-md p-4 h-40 overflow-y-auto text-sm text-gray-400 font-mono">
                                {history.length > 0 ? history.map((entry, index) => (
                                    <p key={index}>{entry}</p>
                                )) : <p>Nenhuma ação registrada ainda.</p>}
                            </div>
                        </section>
                    </div>
                    <AnnotationModal content={modalContent} onClose={() => setModalContent(null)} />
                </React.Fragment>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
