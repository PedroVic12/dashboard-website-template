<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise - Pontos MUST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">

        <!-- Cabeçalho -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Dashboard de Análise de Pontos MUST</h1>
            <p class="text-gray-400 mt-2">Visão geral das solicitações e ressalvas por empresa e ponto de conexão.</p>
        </header>

        <!-- Seção de KPIs (Indicadores Chave) -->
        <section id="kpi-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Os cartões de KPI serão inseridos aqui pelo JavaScript -->
        </section>

        <!-- Seção de Análise por Empresa -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Análise por Empresa</h2>
            <div id="company-analysis-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Os cartões de empresa serão inseridos aqui pelo JavaScript -->
            </div>
        </section>

        <!-- Seção da Tabela Detalhada -->
        <section class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-white mb-4">Detalhes dos Pontos de Conexão</h2>

            <!-- Filtros -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <label for="company-filter" class="block text-sm font-medium text-gray-400 mb-1">Filtrar por
                        Empresa</label>
                    <select id="company-filter"
                        class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">Todas as Empresas</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="search-input" class="block text-sm font-medium text-gray-400 mb-1">Pesquisar</label>
                    <input type="text" id="search-input"
                        class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Buscar por Cód ONS, Instalação, Ressalva...">
                </div>
            </div>

            <!-- Tabela de Dados -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3">Empresa</th>
                            <th scope="col" class="px-6 py-3">Cód ONS</th>
                            <th scope="col" class="px-6 py-3">Instalação</th>
                            <th scope="col" class="px-6 py-3">Tensão (kV)</th>
                            <th scope="col" class="px-6 py-3 text-center">Possui Ressalva?</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- As linhas da tabela serão inseridas aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modal para exibir anotações -->
    <div id="annotation-modal"
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden modal-overlay"
        onclick="closeModal()">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Detalhes da Ressalva</h3>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="text-gray-300 whitespace-pre-wrap">
                <!-- Conteúdo da anotação será inserido aqui -->
            </div>
        </div>
    </div>

    <script>
        // Adiciona um "ouvinte" que espera que todo o conteúdo do HTML seja carregado antes de executar o código.
        document.addEventListener('DOMContentLoaded', () => {
            // --- CARREGAMENTO DOS DADOS ---
            // O JavaScript agora vai buscar os dados do seu arquivo JSON.
            // O './' indica que o arquivo DEVE ESTAR NA MESMA PASTA que este arquivo HTML.
            fetch('must_tables_PDF_notes_merged.json')
                .then(response => {
                    // Verifica se a requisição foi bem-sucedida
                    if (!response.ok) {
                        throw new Error('Erro na rede: ' + response.statusText);
                    }
                    // Converte a resposta para o formato JSON
                    return response.json();
                })
                .then(dados => {
                    // Quando os dados são carregados com sucesso, a variável 'dados' contém todo o seu JSON.
                    // A aplicação é então iniciada com esses dados.
                    initializeApp(dados);
                })
                .catch(error => {
                    console.error('Erro ao carregar os dados:', error);
                    // Mostra uma mensagem de erro no dashboard se o JSON não for encontrado
                    const container = document.querySelector('.container');
                    if (container) {
                        container.innerHTML = `<div class="text-center p-8 text-red-400 bg-gray-800 rounded-lg">
                            <h1 class="text-2xl font-bold">Erro ao Carregar Dados</h1>
                            <p class="mt-2">Não foi possível carregar o arquivo 'must_tables_PDF_notes_merged.json'.</p>
                            <p class="mt-1">Verifique se o arquivo está na mesma pasta que o HTML e se você está executando a página a partir de um servidor local.</p>
                        </div>`;
                    }
                });
        });

        function initializeApp(dados) {
            // Chama todas as funções necessárias para construir o dashboard
            renderKPIs(dados);
            renderCompanyAnalysis(dados);
            populateCompanyFilter(dados);
            renderTable(dados);

            // Adiciona os "ouvintes" para os filtros, para que a tabela se atualize quando o utilizador interagir
            document.getElementById('company-filter').addEventListener('change', () => filterData(dados));
            document.getElementById('search-input').addEventListener('input', () => filterData(dados));
        }

        // Renderiza os cartões de KPI no topo
        function renderKPIs(dados) {
            const uniqueCompanies = new Set(dados.map(item => item.EMPRESA)).size;
            const totalPoints = dados.length;
            const pointsWithRemarks = dados.filter(item => item.Anotacao && String(item.Anotacao).trim() !== 'nan').length;
            const percentageWithRemarks = totalPoints > 0 ? ((pointsWithRemarks / totalPoints) * 100).toFixed(1) : 0;

            const kpiContainer = document.getElementById('kpi-section');
            kpiContainer.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-gray-400 text-sm font-medium">Total de Empresas</h3>
                    <p class="text-3xl font-bold text-white">${uniqueCompanies}</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-gray-400 text-sm font-medium">Total de Pontos de Conexão</h3>
                    <p class="text-3xl font-bold text-white">${totalPoints}</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-gray-400 text-sm font-medium">Pontos com Ressalvas</h3>
                    <p class="text-3xl font-bold text-white">${pointsWithRemarks}</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-gray-400 text-sm font-medium">% de Pontos com Ressalvas</h3>
                    <p class="text-3xl font-bold text-white">${percentageWithRemarks}%</p>
                </div>
            `;
        }

        // Renderiza os cartões de análise por empresa
        function renderCompanyAnalysis(dados) {
            const companyData = {};
            dados.forEach(item => {
                if (!companyData[item.EMPRESA]) {
                    companyData[item.EMPRESA] = { total: 0, withRemarks: 0 };
                }
                companyData[item.EMPRESA].total++;
                if (item.Anotacao && String(item.Anotacao).trim() !== 'nan') {
                    companyData[item.EMPRESA].withRemarks++;
                }
            });

            const companyContainer = document.getElementById('company-analysis-section');
            companyContainer.innerHTML = Object.entries(companyData).map(([company, stats]) => {
                const percentage = stats.total > 0 ? (stats.withRemarks / stats.total) * 100 : 0;
                return `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-white truncate" title="${company}">${company}</h3>
                        <div class="mt-4">
                            <div class="flex justify-between text-gray-400 text-sm">
                                <span>Pontos com Ressalvas</span>
                                <span>${stats.withRemarks} / ${stats.total}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Popula o dropdown de filtro de empresas
        function populateCompanyFilter(dados) {
            const companies = [...new Set(dados.map(item => item.EMPRESA))].sort();
            const filterSelect = document.getElementById('company-filter');
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                filterSelect.appendChild(option);
            });
        }

        // Renderiza as linhas da tabela de dados
        function renderTable(dados) {
            const tableBody = document.getElementById('data-table-body');
            if (!dados || dados.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400">Nenhum resultado encontrado.</td></tr>`;
                return;
            }
            tableBody.innerHTML = dados.map(item => {
                const hasRemark = item.Anotacao && String(item.Anotacao).trim() !== 'nan';
                // Usando encodeURIComponent para tratar caracteres especiais na anotação
                const encodedAnnotation = hasRemark ? encodeURIComponent(item.Anotacao) : '';

                return `
                <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700 ${hasRemark ? 'cursor-pointer' : ''}" 
                    onclick="${hasRemark ? `showModal(this)` : ''}"
                    data-anotacao="${encodedAnnotation}">
                    <td class="px-6 py-4 font-medium text-white">${item.EMPRESA || ''}</td>
                    <td class="px-6 py-4">${item['Cód ONS'] || ''}</td>
                    <td class="px-6 py-4">${item.Instalação || ''}</td>
                    <td class="px-6 py-4">${item['Tensão (kV)'] || ''}</td>
                    <td class="px-6 py-4 text-center">
                        ${hasRemark
                        ? '<span class="inline-block px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Sim</span>'
                        : '<span class="inline-block px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-400 rounded-full">Não</span>'}
                    </td>
                </tr>
            `}).join('');
        }

        // Filtra os dados com base nos inputs e renderiza a tabela novamente
        function filterData(dados) {
            const companyFilter = document.getElementById('company-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            const filteredData = dados.filter(item => {
                const companyMatch = companyFilter === 'all' || item.EMPRESA === companyFilter;

                const searchMatch = !searchTerm ||
                    String(item['Cód ONS']).toLowerCase().includes(searchTerm) ||
                    String(item.Instalação).toLowerCase().includes(searchTerm) ||
                    (item.Anotacao && String(item.Anotacao).toLowerCase().includes(searchTerm));

                return companyMatch && searchMatch;
            });

            renderTable(filteredData);
        }

        // Funções do Modal
        function showModal(element) {
            // Usando decodeURIComponent para ler a anotação corretamente
            const annotation = decodeURIComponent(element.getAttribute('data-anotacao'));
            if (!annotation || annotation === 'null') return;

            document.getElementById('modal-content').textContent = annotation;
            const modal = document.getElementById('annotation-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.style.opacity = 1, 10); // Pequeno delay para a transição funcionar
        }

        function closeModal() {
            const modal = document.getElementById('annotation-modal');
            modal.style.opacity = 0;
            // Espera a transição de opacidade terminar antes de esconder o modal
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    </script>
</body>

</html>