<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise - Pontos MUST (React)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React via CDN -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel (para transpilar JSX no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal-overlay { transition: opacity 0.3s ease; }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">
    <!-- O React vai renderizar a aplicação dentro desta div -->
    <div id="root"></div>

    <!-- Script React com JSX (precisa do type="text/babel") -->
    {% raw %}
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- COMPONENTES REUTILIZÁVEIS ---

        const KpiCard = ({ title, value, unit = '' }) => (
            <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 className="text-gray-400 text-sm font-medium">{title}</h3>
                <p className="text-3xl font-bold text-white">{value}{unit}</p>
            </div>
        );

        const CompanyCard = ({ company, stats }) => {
            const percentage = stats.total > 0 ? (stats.withRemarks / stats.total) * 100 : 0;
            return (
                <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-white truncate" title={company}>{company}</h3>
                    <div className="mt-4">
                        <div className="flex justify-between text-gray-400 text-sm">
                            <span>Pontos com Ressalvas</span>
                            <span>{stats.withRemarks} / {stats.total}</span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5 mt-1">
                            <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AnnotationModal = ({ content, onClose }) => {
            if (!content) return null;
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 modal-overlay"
                    style={{ opacity: 1 }}
                    onClick={onClose}
                >
                    <div 
                        className="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">Detalhes da Ressalva</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div className="text-gray-300 whitespace-pre-wrap">
                            {content}
                        </div>
                    </div>
                </div>
            );
        };

        const ErrorDisplay = ({ error }) => (
            <div className="text-center p-8 text-red-400 bg-gray-800 rounded-lg">
                <h1 className="text-2xl font-bold">Erro ao Carregar Dados</h1>
                <p className="mt-2">Não foi possível carregar o arquivo 'must_tables_PDF_notes_merged.json'.</p>
                <p className="mt-1">Verifique se o arquivo está na mesma pasta que o HTML e se você está executando a página a partir de um servidor local.</p>
                <p className="mt-4 text-xs text-gray-500">Detalhe do erro: {error}</p>
            </div>
        );


        // --- COMPONENTE PRINCIPAL DA APLICAÇÃO ---
        function App() {
            // --- ESTADO DA APLICAÇÃO ---
            const [data, setData] = useState([]);
            const [filters, setFilters] = useState({ company: 'all', search: '' });
            const [modalContent, setModalContent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // --- CARREGAMENTO DOS DADOS (EFEITO) ---
            useEffect(() => {
                fetch('/static/must_tables_PDF_notes_merged.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro na rede: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(fetchedData => {
                        setData(fetchedData);
                        setError(null);
                    })
                    .catch(err => {
                        console.error('Erro ao carregar os dados:', err);
                        setError(err.message);
                    })
                    .finally(() => {
                        setLoading(false);
                    });
            }, []);

            // --- PROCESSAMENTO DOS DADOS PARA ADICIONAR CAMINHOS DE ARQUIVO ---
            const processedData = useMemo(() => {
                // Se não houver dados, retorna um array vazio
                if (!data || data.length === 0) {
                    return [];
                }

                // Mapeia os dados para adicionar o caminho do arquivo
                return data.map((item, index) => {
                    let filePath = 'caminho_padrao.pdf'; // Um valor padrão
                    const empresa = item.EMPRESA;

                    // *** É AQUI QUE VOCÊ PODE ADICIONAR SUA LÓGICA DE 'IF/ELSE' ***
                    // Exemplo:
                    if (empresa === 'SUL E SUDESTE') {
                         filePath = 'https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/EbWWq1r7MnxPvOejycbr82cB5a_rN_PCsDMDjp9r3bF3Ng?e=C7dxKN';
                     } else if (empresa === 'ELETROPAULO') {
                         filePath = `https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/EXzdo_ClziVDrnOHTiGzoysBdqgci92tpuKYN2xKIjPQvw?e=kzrFho`;
                     } else if (empresa == "PIRATININGA") {
                            filePath = `https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/EZGF1uzc1opGujAlp1fwNqcBoLnXsAt532XFPbNrNCwEvQ?e=nEOCn9`;
                     } else if (empresa == "NEOENERGIA ELEKTRO") {
                            filePath = `https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/Eet4gEXFfDNEoPMejiLnMaQBVW1ubN1TxOIvMtLY0yUfPA?e=WruSdk`;
                     } else if (empresa == "ELETROPAULO") {
                            filePath = `https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/EXzdo_ClziVDrnOHTiGzoysBdqgci92tpuKYN2xKIjPQvw?e=b2yXV2`;
                     } else if (empresa == "JAGUARI") {
                            filePath = `https://onsbr-my.sharepoint.com/:b:/g/personal/pedrovictor_veras_ons_org_br/EXzdo_ClziVDrnOHTiGzoysBdqgci92tpuKYN2xKIjPQvw?e=b2yXV2`;
                     } 
                     else {
                         // Lógica padrão que você criou
                         filePath = `MUST_${empresa.replace(/\s+/g, "_")}_${index}.pdf`;
                     }


                    // Retorna o item original com a nova propriedade 'arquivoReferencia'
                    return { ...item, arquivoReferencia: filePath };
                });
            }, [data]); // Este cálculo é refeito apenas quando os 'dados' originais mudam

            // --- CÁLCULOS E FILTRAGEM (USANDO DADOS PROCESSADOS) ---
            const kpis = useMemo(() => {
                if (!processedData.length) return { uniqueCompanies: 0, totalPoints: 0, pointsWithRemarks: 0, percentageWithRemarks: '0.0' };
                const uniqueCompanies = new Set(processedData.map(item => item.EMPRESA)).size;
                const totalPoints = processedData.length;
                const pointsWithRemarks = processedData.filter(item => item.Anotacao && String(item.Anotacao).trim() !== 'nan').length;
                const percentageWithRemarks = totalPoints > 0 ? ((pointsWithRemarks / totalPoints) * 100).toFixed(1) : '0.0';
                return { uniqueCompanies, totalPoints, pointsWithRemarks, percentageWithRemarks };
            }, [processedData]);

            const companyAnalysis = useMemo(() => {
                const companyData = {};
                processedData.forEach(item => {
                    if (!companyData[item.EMPRESA]) {
                        companyData[item.EMPRESA] = { total: 0, withRemarks: 0 };
                    }
                    companyData[item.EMPRESA].total++;
                    if (item.Anotacao && String(item.Anotacao).trim() !== 'nan') {
                        companyData[item.EMPRESA].withRemarks++;
                    }
                });
                return Object.entries(companyData);
            }, [processedData]);

            const uniqueCompaniesList = useMemo(() =>
                [...new Set(processedData.map(item => item.EMPRESA))].sort()
            , [processedData]);

            const filteredData = useMemo(() => {
                return processedData.filter(item => {
                    const companyMatch = filters.company === 'all' || item.EMPRESA === filters.company;
                    const searchTerm = filters.search.toLowerCase();
                    const searchMatch = !searchTerm ||
                        String(item['Cód ONS']).toLowerCase().includes(searchTerm) ||
                        String(item.Instalação).toLowerCase().includes(searchTerm) ||
                        (item.Anotacao && String(item.Anotacao).toLowerCase().includes(searchTerm));
                    return companyMatch && searchMatch;
                });
            }, [processedData, filters]);

            // --- MANIPULADORES DE EVENTOS ---
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const handleRowClick = (annotation) => {
                if (annotation && String(annotation).trim() !== 'nan') {
                    setModalContent(annotation);
                }
            };

            // --- RENDERIZAÇÃO CONDICIONAL ---
            if (loading) {
                return <div className="text-center p-8">Carregando dados...</div>;
            }
            if (error) {
                return <div className="container mx-auto p-4 md:p-8"><ErrorDisplay error={error} /></div>;
            }

            // --- RENDERIZAÇÃO DO JSX ---
            return (
                <React.Fragment>
                    <div className="container mx-auto p-4 md:p-8">
                        <header className="mb-8">
                            <h1 className="text-3xl md:text-4xl font-bold text-white">Dashboard de Análise de Pontos MUST</h1>
                            <p className="text-gray-400 mt-2">Visão geral das solicitações e ressalvas por empresa e ponto de conexão.</p>
                        </header>

                        <section id="kpi-section" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <KpiCard title="Total de Empresas" value={kpis.uniqueCompanies} />
                            <KpiCard title="Total de Pontos de Conexão" value={kpis.totalPoints} />
                            <KpiCard title="Pontos com Ressalvas" value={kpis.pointsWithRemarks} />
                            <KpiCard title="% de Pontos com Ressalvas" value={kpis.percentageWithRemarks} unit="%" />
                        </section>

                        <section className="mb-8">
                            <h2 className="text-2xl font-bold text-white mb-4">Análise por Empresa</h2>
                            <div id="company-analysis-section" className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {companyAnalysis.map(([company, stats]) => (
                                    <CompanyCard key={company} company={company} stats={stats} />
                                ))}
                            </div>
                        </section>

                        <section className="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h2 className="text-2xl font-bold text-white mb-4">Detalhes dos Pontos de Conexão</h2>
                            <div className="flex flex-col md:flex-row gap-4 mb-6">
                                <div className="flex-1">
                                    <label htmlFor="company-filter" className="block text-sm font-medium text-gray-400 mb-1">Filtrar por Empresa</label>
                                    <select id="company-filter" name="company" value={filters.company} onChange={handleFilterChange}
                                        className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="all">Todas as Empresas</option>
                                        {uniqueCompaniesList.map(company => (
                                            <option key={company} value={company}>{company}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label htmlFor="search-input" className="block text-sm font-medium text-gray-400 mb-1">Pesquisar</label>
                                    <input type="text" id="search-input" name="search" value={filters.search} onChange={handleFilterChange}
                                        className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Buscar por Cód ONS, Ressalva..." />
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-300">
                                    <thead className="text-xs text-gray-400 uppercase bg-gray-700">
                                        <tr>
                                            <th scope="col" className="px-6 py-3">Empresa</th>
                                            <th scope="col" className="px-6 py-3">Cód ONS</th>
                                            <th scope="col" className="px-6 py-3">Tensão (kV)</th>
                                            <th scope="col" className="px-6 py-3 text-center">Possui Ressalva?</th>
                                            <th scope="col" className="px-6 py-3">Arquivo de Referência</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.length > 0 ? filteredData.map((item, index) => {
                                            const hasRemark = item.Anotacao && String(item.Anotacao).trim() !== 'nan';
                                            return (
                                                <tr key={`${item['Cód ONS']}-${index}`}
                                                    className={`bg-gray-800 border-b border-gray-700 hover:bg-gray-700 ${hasRemark ? 'cursor-pointer' : ''}`}
                                                    onClick={() => handleRowClick(item.Anotacao)}>
                                                    <td className="px-6 py-4 font-medium text-white">{item.EMPRESA || ''}</td>
                                                    <td className="px-6 py-4">{item['Cód ONS'] || ''}</td>
                                                    <td className="px-6 py-4">{item['Tensão (kV)'] || ''}</td>
                                                    <td className="px-6 py-4 text-center">
                                                        {hasRemark
                                                            ? <span className="inline-block px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Sim</span>
                                                            : <span className="inline-block px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-400 rounded-full">Não</span>
                                                        }
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <a href={item.arquivoReferencia} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">
                                                            Abrir arquivo PDF
                                                        </a>
                                                    </td>
                                                </tr>
                                            );
                                        }) : (
                                            <tr>
                                                <td colSpan="6" className="text-center py-8 text-gray-400">Nenhum resultado encontrado.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                    <AnnotationModal content={modalContent} onClose={() => setModalContent(null)} />
                </React.Fragment>
            );
        }

        // Renderiza o componente App na div#root
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    {% endraw %}
</body>
</html>