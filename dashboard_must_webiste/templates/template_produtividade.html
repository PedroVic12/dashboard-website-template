<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtividade Mestre (UI Refinada)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js para Gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Estilo para a barra de rolagem, para um visual mais clean */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 sm:p-4 md:p-6 font-sans text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ====================================================================
    // CONTROLLER DE "BANCO DE DADOS" (localStorage)
    // ====================================================================
    class DatabaseController {
        constructor(key = 'produtividadeMestreApp_v6_analytics') {
            this.key = key;
        }
        load() {
            try {
                const data = localStorage.getItem(this.key);
                return data ? JSON.parse(data) : null;
            } catch (error) { console.error("Erro ao carregar dados:", error); return null; }
        }
        save(state) {
            try {
                const data = JSON.stringify(state);
                localStorage.setItem(this.key, data);
            } catch (error) { console.error("Erro ao salvar dados:", error); }
        }
    }

    // ====================================================================
    // COMPONENTES DA APLICA√á√ÉO
    // ====================================================================

    // -----------------------------
    // Componente: Checklist (Com modo Edi√ß√£o/Visualiza√ß√£o)
    // -----------------------------
    function Checklist({ 
        markdownText, tasks, updateMarkdown, toggleTask, 
        inputMode, setInputMode, githubUrl, setGithubUrl, handleFetch, loading, error 
    }) {
        const [isEditing, setIsEditing] = useState(false);

        const TaskList = ({ tasks, toggleTask }) => {
            const groupedTasks = tasks.reduce((acc, task) => {
                acc[task.category] = acc[task.category] || [];
                acc[task.category].push(task);
                return acc;
            }, {});

            return (
                <div className="space-y-4">
                    {Object.entries(groupedTasks).map(([category, items]) => (
                        <div key={category}>
                            <h3 className="font-bold text-lg mb-2 text-slate-700">{category}</h3>
                            <div className="bg-white rounded-lg shadow-sm border border-slate-200">
                                {items.map((task, index) => (
                                    <div key={task.id} className={`flex items-center p-3 hover:bg-slate-50 ${index < items.length - 1 ? 'border-b border-slate-200' : ''}`}>
                                        <input type="checkbox" checked={task.done} onChange={() => toggleTask(task.id)} className="ml-1 mr-4 w-5 h-5 accent-blue-600 rounded cursor-pointer flex-shrink-0" />
                                        <label className={`flex-grow cursor-pointer text-sm sm:text-base ${task.done ? "line-through text-slate-400" : "text-slate-700"}`} onClick={() => toggleTask(task.id)}>{task.item}</label>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        return (
            <div className="p-2 sm:p-4">
                <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 className="text-2xl font-bold text-slate-800">üìñ Checklist Central</h2>
                    <button onClick={() => setIsEditing(!isEditing)} className="px-4 py-2 text-sm font-semibold bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 transition-colors">
                        {isEditing ? 'Ver Checklist' : 'Editar Markdown'}
                    </button>
                </div>
                
                <div className="bg-slate-200/50 p-3 sm:p-4 rounded-lg mb-6">
                    <div className="flex items-center space-x-4 mb-4">
                        <label className="cursor-pointer text-sm font-medium"><input type="radio" name="inputMode" value="text" checked={inputMode === 'text'} onChange={(e) => setInputMode(e.target.value)} className="mr-1"/> Digitar</label>
                        <label className="cursor-pointer text-sm font-medium"><input type="radio" name="inputMode" value="url" checked={inputMode === 'url'} onChange={(e) => setInputMode(e.target.value)} className="mr-1"/> URL</label>
                    </div>
                    {inputMode === 'url' && (
                        <div className="flex flex-col sm:flex-row items-center gap-2">
                            <input type="text" value={githubUrl} onChange={(e) => setGithubUrl(e.target.value)} placeholder="Cole a URL RAW do arquivo .md do GitHub" className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                            <button onClick={handleFetch} disabled={loading} className="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300">{loading ? 'Buscando...' : 'Buscar'}</button>
                        </div>
                    )}
                    {error && <p className="text-red-500 mt-2 text-sm">{error}</p>}
                </div>
                
                {isEditing ? (
                     <textarea value={markdownText} onChange={(e) => updateMarkdown(e.target.value)} className="w-full h-64 sm:h-96 p-3 border border-slate-300 rounded-lg font-mono text-sm bg-white focus:ring-2 focus:ring-blue-500" placeholder="Digite ou cole seu checklist aqui..." />
                ) : (
                    <TaskList tasks={tasks} toggleTask={toggleTask} />
                )}
            </div>
        );
    }
    
    // -----------------------------
    // Componente: Matriz de Eisenhower
    // -----------------------------
    function MatrizEisenhower({ tasks, moveTask }) {
        const quadrants = {
            'U-I': { title: "üî• Urgente & Importante", items: tasks.filter(t => t.quadrant === 'U-I' && !t.done) },
            'NU-I': { title: "‚úÖ N√£o Urgente & Importante", items: tasks.filter(t => t.quadrant === 'NU-I' && !t.done) },
            'U-NI': { title: "‚ö†Ô∏è Urgente & N√£o Importante", items: tasks.filter(t => t.quadrant === 'U-NI' && !t.done) },
            'NU-NI': { title: "üóëÔ∏è N√£o Urgente & N√£o Importante", items: tasks.filter(t => t.quadrant === 'NU-NI' && !t.done) }
        };
        const handleDragStart = (e, taskId) => e.dataTransfer.setData("taskId", taskId);
        const handleDrop = (e, toQuadrant) => moveTask(e.dataTransfer.getData("taskId"), toQuadrant);
        const handleDragOver = (e) => e.preventDefault();
        return (
            <div className="p-2 sm:p-4"><h2 className="text-2xl font-bold mb-4 text-slate-800">‚è≥ Matriz Eisenhower</h2><div className="grid grid-cols-1 lg:grid-cols-2 gap-4"><div className="bg-white rounded-xl shadow-md p-4 min-h-[200px] border-t-4 border-red-500" onDrop={(e)=>handleDrop(e,'U-I')} onDragOver={handleDragOver}><h3 className="font-semibold mb-3 text-lg text-red-600">{quadrants['U-I'].title}</h3><ul className="space-y-2">{quadrants['U-I'].items.map(t=>(<li key={t.id} draggable onDragStart={(e)=>handleDragStart(e,t.id)} className="border border-slate-200 rounded-lg p-2 cursor-move bg-slate-50 hover:bg-slate-100 text-sm">{t.item}</li>))}{quadrants['U-I'].items.length === 0 && <p className="text-slate-400 text-sm">Arraste tarefas para c√°</p>}</ul></div><div className="bg-white rounded-xl shadow-md p-4 min-h-[200px] border-t-4 border-blue-500" onDrop={(e)=>handleDrop(e,'NU-I')} onDragOver={handleDragOver}><h3 className="font-semibold mb-3 text-lg text-blue-600">{quadrants['NU-I'].title}</h3><ul className="space-y-2">{quadrants['NU-I'].items.map(t=>(<li key={t.id} draggable onDragStart={(e)=>handleDragStart(e,t.id)} className="border border-slate-200 rounded-lg p-2 cursor-move bg-slate-50 hover:bg-slate-100 text-sm">{t.item}</li>))}{quadrants['NU-I'].items.length === 0 && <p className="text-slate-400 text-sm">Tarefas de backlog aparecem aqui.</p>}</ul></div><div className="bg-white rounded-xl shadow-md p-4 min-h-[200px] border-t-4 border-yellow-500" onDrop={(e)=>handleDrop(e,'U-NI')} onDragOver={handleDragOver}><h3 className="font-semibold mb-3 text-lg text-yellow-600">{quadrants['U-NI'].title}</h3><ul className="space-y-2">{quadrants['U-NI'].items.map(t=>(<li key={t.id} draggable onDragStart={(e)=>handleDragStart(e,t.id)} className="border border-slate-200 rounded-lg p-2 cursor-move bg-slate-50 hover:bg-slate-100 text-sm">{t.item}</li>))}{quadrants['U-NI'].items.length === 0 && <p className="text-slate-400 text-sm">Arraste tarefas para c√°</p>}</ul></div><div className="bg-white rounded-xl shadow-md p-4 min-h-[200px] border-t-4 border-slate-500" onDrop={(e)=>handleDrop(e,'NU-NI')} onDragOver={handleDragOver}><h3 className="font-semibold mb-3 text-lg text-slate-600">{quadrants['NU-NI'].title}</h3><ul className="space-y-2">{quadrants['NU-NI'].items.map(t=>(<li key={t.id} draggable onDragStart={(e)=>handleDragStart(e,t.id)} className="border border-slate-200 rounded-lg p-2 cursor-move bg-slate-50 hover:bg-slate-100 text-sm">{t.item}</li>))}{quadrants['NU-NI'].items.length === 0 && <p className="text-slate-400 text-sm">Arraste tarefas para c√°</p>}</ul></div></div></div>
        );
    }

    // -----------------------------
    // Componente: Pomodoro Timer (Com Notifica√ß√µes e Configura√ß√µes)
    // -----------------------------
    function PomodoroTimer({ tasks, logSession, settings, updateSettings }) {
        const [time, setTime] = useState(settings.pomodoroDuration * 60);
        const [running, setRunning] = useState(false);
        const [mode, setMode] = useState('pomodoro');
        const [visualState, setVisualState] = useState('idle'); // idle, running, finished
        const [selectedCategory, setSelectedCategory] = useState('');
        const [selectedTaskId, setSelectedTaskId] = useState('');

        const categories = [...new Set(tasks.map(t => t.category))];
        const tasksInCategory = tasks.filter(t => t.category === selectedCategory && !t.done);

        useEffect(() => {
            if ('Notification' in window && Notification.permission !== 'granted') Notification.requestPermission();
        }, []);

        const playNotificationSound = () => {
            try { const audioContext=new(window.AudioContext||window.webkitAudioContext)(); const o=audioContext.createOscillator(); const g=audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); o.type='sine'; o.frequency.setValueAtTime(440,audioContext.currentTime); g.gain.setValueAtTime(0.5,audioContext.currentTime); o.start(); o.stop(audioContext.currentTime+0.5); } catch (e) { console.error("N√£o foi poss√≠vel tocar o som de notifica√ß√£o.", e); }
        };
        const showBrowserNotification = (title, body) => {
            if ('Notification' in window && Notification.permission === 'granted') new Notification(title, { body });
        };
        
        useEffect(() => {
            let interval;
            if (running && time > 0) {
                document.title = `${formatTime(time)} - Foco`;
                interval = setInterval(() => setTime(t => t - 1), 1000);
            } else if (running && time === 0) {
                setRunning(false); setVisualState('finished');
                document.title = "Produtividade Mestre";
                playNotificationSound();
                if (mode === 'pomodoro' && selectedTaskId) {
                    logSession(settings.pomodoroDuration * 60, selectedTaskId);
                    const task = tasks.find(t => t.id === selectedTaskId);
                    showBrowserNotification('Pomodoro Finalizado!', `Foco em "${task?.item||'tarefa'}" conclu√≠do.`);
                    setSelectedTaskId(''); 
                } else { showBrowserNotification('Pausa Finalizada!', `Sua pausa terminou. Hora de voltar ao foco!`); }
            }
            return () => { clearInterval(interval); document.title = "Produtividade Mestre"; };
        }, [running, time, selectedTaskId, settings.pomodoroDuration]);

        const selectMode = (newMode) => {
            setMode(newMode);
            setRunning(false);
            setVisualState('idle');
            setTime(newMode === 'pomodoro' ? settings.pomodoroDuration * 60 : settings.shortBreakDuration * 60);
        };

        const startPauseTimer = () => {
            if (running) { setRunning(false); setVisualState('idle'); }
            else { setRunning(true); setVisualState('running'); }
        }

        const formatTime = (t) => `${String(Math.floor(t / 60)).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;

        const timerContainerClasses = {
            idle: 'bg-slate-100/50',
            running: 'bg-red-100',
            finished: 'bg-green-100'
        }[visualState];

        return (
            <div className={`p-2 sm:p-4 flex flex-col items-center justify-center h-full rounded-lg transition-colors duration-500 ${timerContainerClasses}`}>
                <h2 className="text-2xl font-bold mb-4 text-slate-800">‚è±Ô∏è Pomodoro Timer</h2>
                <div className="w-full max-w-md bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-4">
                    <h3 className="font-semibold text-slate-700 mb-2">Selecione uma Tarefa para Focar</h3>
                    <div className="flex flex-col sm:flex-row gap-2"><select value={selectedCategory} onChange={e => { setSelectedCategory(e.target.value); setSelectedTaskId(''); }} className="flex-1 p-2 border border-slate-300 rounded-lg bg-slate-50 text-sm"><option value="">-- Categoria --</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select><select value={selectedTaskId} onChange={e => setSelectedTaskId(e.target.value)} disabled={!selectedCategory || tasksInCategory.length === 0} className="flex-1 p-2 border border-slate-300 rounded-lg bg-slate-50 disabled:bg-slate-200 text-sm"><option value="">-- Tarefa --</option>{tasksInCategory.map(t => <option key={t.id} value={t.id}>{t.item}</option>)}</select></div>
                </div>
                <div className="w-full max-w-md bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
                    <h3 className="font-semibold text-slate-700 mb-3">Configura√ß√µes</h3>
                    <div className="flex justify-between items-center text-sm"><label htmlFor="pomodoro-duration" className="text-slate-600">Dura√ß√£o Foco (min):</label><input id="pomodoro-duration" type="number" value={settings.pomodoroDuration} onChange={(e) => updateSettings('pomodoroDuration', Number(e.target.value))} className="w-20 p-1 border border-slate-300 rounded-md text-center"/></div>
                    <div className="flex justify-between items-center text-sm mt-2"><label htmlFor="break-duration" className="text-slate-600">Dura√ß√£o Pausa (min):</label><select id="break-duration" value={settings.shortBreakDuration} onChange={(e) => updateSettings('shortBreakDuration', Number(e.target.value))} className="w-20 p-1 border border-slate-300 rounded-md"><option value="5">5</option><option value="10">10</option><option value="15">15</option></select></div>
                </div>
                <div className="flex space-x-2 mb-6">
                    <button onClick={() => selectMode('pomodoro')} className={`px-3 py-1 rounded-full text-sm font-semibold ${mode === 'pomodoro' ? 'bg-red-500 text-white shadow' : 'bg-slate-200 text-slate-600'}`}>Pomodoro</button>
                    <button onClick={() => selectMode('short')} className={`px-3 py-1 rounded-full text-sm font-semibold ${mode === 'short' ? 'bg-green-500 text-white shadow' : 'bg-slate-200 text-slate-600'}`}>Pausa Curta</button>
                </div>
                <div className="text-5xl sm:text-7xl font-mono text-slate-800 mb-6">{formatTime(time)}</div>
                <div><button onClick={startPauseTimer} disabled={mode === 'pomodoro' && !selectedTaskId} className="px-8 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition text-lg w-32 disabled:bg-slate-300 disabled:cursor-not-allowed">{running ? 'Pausar' : 'Iniciar'}</button></div>
            </div>
        );
    }
    
    // -----------------------------
    // Componente: Gr√°ficos (Analytics Aprimorado)
    // -----------------------------
    function Graficos({ logs, tasks, exportReport }) {
        const dailyChartRef = useRef(null);
        const weeklyChartRef = useRef(null);

        // Fun√ß√£o para gerar cores consistentes para categorias
        const getCategoryColor = (category) => {
            let hash = 0;
            for (let i = 0; i < category.length; i++) {
                hash = category.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        };

        useEffect(() => {
            const taskMap = new Map(tasks.map(t => [t.id, t]));
            const logsWithCategories = logs.map(log => ({...log, category: taskMap.get(log.taskId)?.category })).filter(l => l.category);
            
            // --- Dados para Gr√°fico Di√°rio ---
            const today = new Date().setHours(0,0,0,0);
            const todayLogs = logsWithCategories.filter(l => new Date(l.timestamp).setHours(0,0,0,0) === today);
            const dailyCategoryData = todayLogs.reduce((acc, log) => {
                acc[log.category] = (acc[log.category] || 0) + log.duration;
                return acc;
            }, {});
            
            // --- Dados para Gr√°fico Semanal ---
            const allCategories = [...new Set(logsWithCategories.map(l => l.category))];
            const categoryColors = allCategories.reduce((acc, cat) => ({ ...acc, [cat]: getCategoryColor(cat) }), {});
            const labels = [];
            const weeklyCategoryData = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i); d.setHours(0, 0, 0, 0);
                labels.push(d.toLocaleDateString('pt-BR', { weekday: 'short' }));
                const dayLogs = logsWithCategories.filter(l => new Date(l.timestamp).setHours(0, 0, 0, 0) === d.getTime());
                allCategories.forEach(cat => {
                    if (!weeklyCategoryData[cat]) weeklyCategoryData[cat] = Array(7).fill(0);
                    weeklyCategoryData[cat][6 - i] = dayLogs.filter(l => l.category === cat).reduce((sum, l) => sum + l.duration, 0) / 3600;
                });
            }

            // --- Renderiza√ß√£o dos Gr√°ficos ---
            const dailyCtx = dailyChartRef.current.getContext('2d');
            const weeklyCtx = weeklyChartRef.current.getContext('2d');
            
            let dailyChart = new Chart(dailyCtx, {
                type: 'doughnut',
                data: { labels: Object.keys(dailyCategoryData), datasets: [{ data: Object.values(dailyCategoryData).map(d => (d/3600).toFixed(2)), backgroundColor: Object.keys(dailyCategoryData).map(cat => categoryColors[cat] || '#cccccc'), borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            let weeklyChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: { labels, datasets: Object.entries(weeklyCategoryData).map(([category, data]) => ({ label: category, data, backgroundColor: categoryColors[category] })) },
                options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Horas' } } }, responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            return () => { dailyChart.destroy(); weeklyChart.destroy(); };
        }, [logs, tasks]);

        const dailyCategoryData = (() => {
            const taskMap = new Map(tasks.map(t => [t.id, t]));
            const logsWithCategories = logs.map(log => ({...log, category: taskMap.get(log.taskId)?.category })).filter(l => l.category);
            const today = new Date().setHours(0,0,0,0);
            const todayLogs = logsWithCategories.filter(l => new Date(l.timestamp).setHours(0,0,0,0) === today);
            return todayLogs.reduce((acc, log) => {
                acc[log.category] = (acc[log.category] || 0) + log.duration;
                return acc;
            }, {});
        })();

        const totalDailyHours = Object.values(dailyCategoryData || {}).reduce((s, d) => s + d, 0) / 3600;

        return (
            <div className="p-2 sm:p-4">
                <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 className="text-2xl font-bold text-slate-800">üìä Gr√°ficos de Produtividade</h2>
                    <button onClick={exportReport} className="px-4 py-2 text-sm font-semibold bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 transition-colors">Exportar Relat√≥rio (JSON)</button>
                </div>
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div className="bg-white p-4 rounded-lg shadow-md border border-slate-200">
                        <h3 className="font-semibold mb-2 text-center text-slate-700">Foco por Categoria (Hoje)</h3>
                        <div className="relative h-64 mb-4"><canvas ref={dailyChartRef}></canvas></div>
                        {Object.keys(dailyCategoryData || {}).length > 0 && <table className="w-full text-sm text-left text-slate-500"><tbody>{Object.entries(dailyCategoryData).map(([cat, dur]) => (<tr key={cat} className="border-b"><th scope="row" className="py-2 px-3 font-medium text-slate-900">{cat}</th><td className="py-2 px-3">{(dur/3600).toFixed(2)}h</td><td className="py-2 px-3">{totalDailyHours > 0 ? ((dur/3600)/totalDailyHours*100).toFixed(0) : 0}%</td></tr>))}</tbody></table>}
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow-md border border-slate-200">
                        <h3 className="font-semibold mb-2 text-center text-slate-700">Foco por Categoria (√öltimos 7 Dias)</h3>
                        <div className="relative h-96"><canvas ref={weeklyChartRef}></canvas></div>
                    </div>
                </div>
            </div>
        );
    }

    // ====================================================================
    // COMPONENTE PRINCIPAL (CONTROLADOR DE ESTADO)
    // ====================================================================
    function App() {
        const db = new DatabaseController();
        const initialMarkdown = `# Est√°gio ONS __BACKLOG
- [ ] Relat√≥rio + Reuni√£o Semanal
- [ ] Banco de Dados com SQL e relacionamentos com Dashboard Streamlit

# Eng. El√©trica UFF 2025 __BACKLOG
- [ ] Minicurso CC + CD
- [ ] Leitura Orante do livo Teoria e controle moderno`;

        const [state, setState] = useState(() => {
            const loaded = db.load();
            const defaults = {
                markdownText: initialMarkdown,
                pomodoroLogs: [],
                activeTab: 'matriz',
                inputMode: 'text',
                githubUrl: '',
                pomodoroDuration: 25,
                shortBreakDuration: 5,
            };
            return { ...defaults, ...loaded };
        });
        
        const [tasks, setTasks] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => { db.save(state); }, [state]);

        useEffect(() => {
            const quadrantTags = ['@U-I', '@U-NI', '@NU-I', '@NU-NI'];
            const lines = state.markdownText.trim().split("\n"); let category = "Geral";
            const parsed = lines.map((line, index) => {
                const trimmedLine = line.trim();
                if(trimmedLine.startsWith("#")){ category = trimmedLine.replace(/#/g,"").trim(); return null; }
                if(trimmedLine.startsWith("- [")){
                    const done = trimmedLine.includes("- [x]");
                    let item = trimmedLine.substring(trimmedLine.indexOf("]")+1).trim();
                    let quadrant = null;
                    for(const tag of quadrantTags){ if(item.includes(tag)){ quadrant = tag.substring(1); item = item.replace(tag,'').trim(); break; } }
                    if (!quadrant) { quadrant = 'NU-I'; }
                    return{id:`task-${index}`,category,item,done,quadrant,originalLine:line};
                } return null;
            }).filter(Boolean);
            setTasks(parsed);
        }, [state.markdownText]);

        const updateState = (key, value) => setState(s => ({ ...s, [key]: value }));
        
        const toggleTask = (taskId) => {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Extrai o √≠ndice da linha do ID da tarefa
            const lineIndex = parseInt(taskId.split('-')[1], 10);
            
            const lines = state.markdownText.split('\n');
            
            // Garante que o √≠ndice √© v√°lido
            if (lineIndex >= 0 && lineIndex < lines.length) {
                const currentLine = lines[lineIndex];
                
                // Cria a nova linha com o estado invertido
                const newLine = task.done 
                    ? currentLine.replace('- [x]', '- [ ]') 
                    : currentLine.replace('- [ ]', '- [x]');
                
                // Atualiza a linha espec√≠fica no array
                lines[lineIndex] = newLine;
                
                // Junta o array de volta em uma string e atualiza o estado
                updateState('markdownText', lines.join('\n'));
            } else {
                console.error("√çndice de tarefa inv√°lido:", taskId);
            }
        };
        
        const moveTask = (taskId, newQuadrant) => {
            const task = tasks.find(t => t.id === taskId); if (!task) return;
            let newLine = task.originalLine.replace(/@U-I|@U-NI|@NU-I|@NU-NI/g, '').trim();
            updateState('markdownText', state.markdownText.replace(task.originalLine, `${newLine} @${newQuadrant}`));
        };
        
        const logSession = (duration, taskId) => {
            const newLog = { taskId, duration, timestamp: new Date().toISOString() };
            setState(s => ({...s, pomodoroLogs: [...s.pomodoroLogs, newLog] }));
            const task = tasks.find(t => t.id === taskId);
            if(task && !task.done){ toggleTask(taskId); }
        };
        
        const handleFetch = async () => {
            if(!state.githubUrl){setError("Por favor, insira uma URL.");return;}
            setLoading(true); setError(null);
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const res = await fetch(proxyUrl + encodeURIComponent(state.githubUrl));
                if(!res.ok) throw new Error(`Erro: ${res.statusText}`);
                const text = await res.text();
                updateState('markdownText', text);
            } catch (err) { setError(err.message); } 
            finally { setLoading(false); }
        };

        const exportForPandas = () => {
            const flatData = state.pomodoroLogs.map(log => {
                const task = tasks.find(t => t.id === log.taskId);
                return {
                    data: new Date(log.timestamp).toISOString(),
                    duracao_segundos: log.duration,
                    tarefa: task ? task.item : 'Tarefa n√£o encontrada',
                    categoria: task ? task.category : 'N/A',
                    quadrante: task ? task.quadrant : 'N/A'
                };
            });

            const jsonString = JSON.stringify(flatData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio-pomodoro-pandas.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };


        const tabs = [{ id: "checklist", label: "Checklist", icon: "üìñ" }, { id: "matriz", label: "Matriz", icon: "‚è≥" }, { id: "pomodoro", label: "Pomodoro", icon: "‚è±Ô∏è" }, { id: "graficos", label: "Gr√°ficos", icon: "üìä"}];
        const pomodoroSettings = { pomodoroDuration: state.pomodoroDuration, shortBreakDuration: state.shortBreakDuration };

        const renderContent = () => {
            switch(state.activeTab) {
                case "checklist": return <Checklist markdownText={state.markdownText} tasks={tasks} updateMarkdown={(v) => updateState('markdownText', v)} toggleTask={toggleTask} inputMode={state.inputMode} setInputMode={(v) => updateState('inputMode', v)} githubUrl={state.githubUrl} setGithubUrl={(v) => updateState('githubUrl', v)} handleFetch={handleFetch} loading={loading} error={error} />;
                case "matriz": return <MatrizEisenhower tasks={tasks} moveTask={moveTask} />;
                case "pomodoro": return <PomodoroTimer tasks={tasks} logSession={logSession} settings={pomodoroSettings} updateSettings={updateState} />;
                case "graficos": return <Graficos logs={state.pomodoroLogs} tasks={tasks} exportReport={exportForPandas} />;
                default: return null;
            }
        };

        return (
            <div className="max-w-7xl mx-auto bg-slate-50 rounded-2xl shadow-lg overflow-hidden border border-slate-200">
                <header className="p-4 sm:p-5 border-b border-slate-200"><div className="flex justify-between items-center flex-col sm:flex-row gap-2"><div className="text-center sm:text-left"><h1 className="text-xl sm:text-2xl font-bold text-slate-800">Produtividade Mestre</h1><p className="text-slate-500 text-sm sm:text-base">Seu sistema de produtividade integrado.</p></div><div className="text-sm shrink-0"><a href="https://github.com/PedroVic12" target="_blank" rel="noopener noreferrer" className="font-semibold text-slate-600 hover:text-blue-600 transition-colors mr-4">GitHub</a><a href="https://www.linkedin.com/in/pedrovictordev" target="_blank" rel="noopener noreferrer" className="font-semibold text-slate-600 hover:text-blue-600 transition-colors">LinkedIn</a></div></div></header>
                <div className="flex flex-col md:flex-row">
                    <nav className="flex justify-around md:justify-start md:flex-col border-b md:border-b-0 md:border-r border-slate-200 p-2 md:p-3 md:w-48">
                      {tabs.map(t=>(<button key={t.id} onClick={()=>updateState('activeTab', t.id)} className={`flex items-center justify-center md:justify-start text-left w-full px-3 py-2 my-1 rounded-lg transition-colors text-sm font-medium ${state.activeTab === t.id ? "bg-blue-600 text-white shadow-sm" : "hover:bg-slate-200/50 text-slate-600"}`}><span className="mr-0 md:mr-3 text-xl">{t.icon}</span><span className="hidden md:inline">{t.label}</span></button>))}
                    </nav>
                    <main className="flex-1 bg-slate-100/50 p-0 sm:p-2 min-h-[calc(100vh-150px)]">
                      {renderContent()}
                    </main>
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

